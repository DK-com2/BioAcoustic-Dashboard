# BirdNet データベースビューワー - Phase 2: 音声切り取り再生機能

## 🎯 Phase 2で実装された機能

### 🎵 音声切り取り再生機能
- **指定時間範囲での音声再生**: 検出された鳥の鳴き声の時間範囲を正確に再生
- **前後コンテキスト制御**: 検出範囲の前後に含める時間を0-10秒で調整可能
- **カスタム時間範囲設定**: 検出範囲とは異なる任意の時間範囲を指定可能
- **リアルタイム音声生成**: ブラウザ上で音声セグメントを動的に生成・再生

### 📊 音声波形表示
- **インタラクティブ波形**: Plotlyを使用したインタラクティブな波形表示
- **検出範囲のハイライト**: 鳥の鳴き声が検出された時間範囲を赤色でハイライト
- **波形統計情報**: サンプル数、ビット深度、ダイナミックレンジなどの詳細統計

### 🎧 多機能音声プレイヤー
- **タブ型UI**: 切り取り再生、波形表示、完全ファイル再生を分離
- **音声統計表示**: 総時間、最大/RMS振幅、サンプリングレートの表示
- **エラーハンドリング**: 音声ファイル読み込み失敗時の適切なエラー表示

## 🏗️ 新しいファイル構造

```
streamlit_viewer/
├── db_viewer.py              # メインページ（既存）
├── config.py                # 設定ファイル（既存）
├── pages/
│   └── audio_detail.py      # 音声詳細ページ（大幅拡張）
├── utils/                   # 新規追加
│   ├── __init__.py         # パッケージ初期化
│   └── audio_processor.py  # 音声処理ユーティリティ（新規）
└── README_PHASE2.md        # Phase 2の実装メモ（このファイル）
```

## 🔧 技術的実装詳細

### AudioProcessor クラス
```python
class AudioProcessor:
    def load_audio(file_path)           # 音声ファイル読み込み
    def extract_segment(...)            # 指定範囲の音声切り取り
    def save_segment_as_bytes(...)      # セグメントのバイト列変換
    def generate_waveform_plot_data(...)# 波形プロット用データ生成
    def calculate_audio_statistics(...) # 音声統計情報計算
```

### AudioPlayerComponent クラス
```python
class AudioPlayerComponent:
    @staticmethod
    def render_segment_player(...)      # セグメントプレイヤーのレンダリング
    @staticmethod
    def render_waveform(...)           # 波形のレンダリング
```

### キャッシュ機能
- `@st.cache_data`による音声ファイルの読み込みキャッシュ
- 大きな音声ファイルの重複処理を防止
- メモリ効率的な処理によるパフォーマンス向上

## 🚀 使用方法

### 1. 基本的な音声切り取り再生
1. メインページで興味のある検出レコードを選択
2. 「🎧 音声詳細を表示」ボタンをクリック
3. 「🎵 音声切り取り再生」タブを選択
4. 「前後のコンテキスト」スライダーで前後の時間を調整（0-10秒）
5. 「🎵 音声セグメントを生成」ボタンをクリック
6. 生成された音声セグメントを再生

### 2. カスタム時間範囲での再生
1. 「カスタム時間範囲を設定」チェックボックスをオン
2. 「開始時間」と「終了時間」を秒単位で指定
3. 「🎵 音声セグメントを生成」ボタンをクリック
4. 指定した範囲の音声セグメントを再生

### 3. 波形表示
1. 「📊 波形表示」タブを選択
2. インタラクティブな波形グラフが表示される
3. 赤色のハイライト部分が検出された鳥の鳴き声の範囲
4. 「📈 波形統計情報」で詳細な統計を確認

## 🎛️ 機能の詳細

### 前後コンテキスト機能
- **目的**: 検出された鳥の鳴き声の前後の音も含めて再生
- **設定範囲**: 0-10秒（0.5秒刻み）
- **用途**: 鳥の鳴き声の文脈や環境音を確認

### カスタム時間範囲機能
- **目的**: 検出範囲とは異なる任意の時間範囲を再生
- **入力検証**: 開始時間 < 終了時間、ファイル長以内
- **用途**: 複数の鳥の鳴き声や特定の部分を詳細に分析

### 波形表示機能
- **Plotlyベース**: ズーム、パン、ホバー情報などインタラクティブ操作
- **検出範囲ハイライト**: 赤色の半透明領域で視覚的に表示
- **ダウンサンプリング**: 2000ポイントまでダウンサンプリングして高速表示

### 音声統計情報
- **総時間**: ファイル全体の再生時間
- **最大振幅**: 音声の最大レベル
- **RMS振幅**: 音声の実効値（音量の目安）
- **サンプリングレート**: 音質を表す指標

## 🔍 技術仕様

### 対応音声フォーマット
- **入力**: .wav, .mp3, .flac, .aac, .ogg, .m4a
- **出力**: WAV形式（ブラウザ互換性重視）
- **サンプリングレート**: 22050Hz（BirdNET標準）

### パフォーマンス最適化
- **音声読み込みキャッシュ**: 同じファイルの重複読み込みを防止
- **ダウンサンプリング**: 波形表示の高速化
- **メモリ効率**: 必要な部分のみメモリに保持
- **エラーハンドリング**: 適切なエラーメッセージとフォールバック

### 依存ライブラリ
```python
librosa>=0.9.2      # 音声読み込み・処理
soundfile           # 音声ファイル出力
numpy              # 数値計算
plotly>=5.15.0     # インタラクティブな波形表示
streamlit>=1.28.0  # Webアプリケーションフレームワーク
```

## 🚧 制限事項

### 現在の制限
1. **音声切り取り精度**: サンプル単位での精密な切り取りのため、非常に短い検出（0.1秒未満）では精度が制限される
2. **大容量ファイル**: 非常に大きな音声ファイル（>100MB）では読み込みに時間がかかる場合
3. **ブラウザ制限**: 音声再生はブラウザの対応フォーマットに依存
4. **同時処理**: 複数ユーザーが同時に大きなファイルを処理する際のメモリ使用量

### 推奨環境
- **メモリ**: 8GB以上（大容量音声ファイル処理時）
- **ブラウザ**: Chrome, Firefox, Safari, Edge（最新版）
- **音声ファイル**: 1ファイルあたり50MB以下を推奨

## 🔮 今後の実装予定（Phase 3）

### 📊 スペクトログラム表示
- **周波数解析**: 音声の周波数成分を可視化
- **時間-周波数表示**: 2次元のスペクトログラム
- **検出範囲ハイライト**: 周波数領域での検出範囲表示

### 🎛️ 品質評価UI
- **検出結果の評価**: 正解/不正解の手動ラベリング
- **コメント機能**: 検出結果への詳細コメント
- **評価者管理**: 誰が評価したかの記録

### 🔍 高度な音声解析
- **複数検出の表示**: 1つのファイル内の複数の鳥の検出
- **音声品質指標**: SNR、ノイズレベルの表示
- **類似音声検索**: 似た特徴を持つ音声の検索

## 📈 パフォーマンス指標

### 処理速度の目安
| ファイルサイズ | 読み込み時間 | セグメント生成時間 |
|---------------|-------------|-------------------|
| 5MB (5分)     | 1-2秒       | 0.5秒            |
| 20MB (20分)   | 3-5秒       | 1-2秒            |
| 50MB (50分)   | 8-12秒      | 2-4秒            |

### メモリ使用量
- **基本**: 音声ファイルサイズの2-3倍
- **キャッシュ**: 処理済みファイルは追加メモリ不要
- **波形表示**: 元ファイルの1/10程度（ダウンサンプリング）

## 🐛 トラブルシューティング

### よくある問題と解決法

#### 1. 音声ファイルが見つからない
**症状**: "❌ 音声ファイルが見つかりません"
**原因**: 
- ファイルパスの不整合
- ファイルが移動または削除された
**解決法**:
- `database/audio/completed/`, `failed/`, `inbox/`フォルダを確認
- ファイル名に拡張子が含まれているか確認

#### 2. 音声読み込みエラー
**症状**: "音声読み込みエラー: ..."
**原因**:
- 対応していない音声フォーマット
- 破損した音声ファイル
- メモリ不足
**解決法**:
- ファイルを標準的なWAVまたはMP3形式に変換
- ファイルサイズを確認（50MB以下推奨）
- ブラウザを再起動してメモリをクリア

#### 3. 波形表示エラー
**症状**: "波形表示エラー: ..."
**原因**:
- Plotlyライブラリの問題
- データサイズが大きすぎる
**解決法**:
- ページを再読み込み
- より短い音声セグメントで試行

#### 4. セグメント生成の失敗
**症状**: "音声セグメント生成エラー: ..."
**原因**:
- 無効な時間範囲指定
- メモリ不足
**解決法**:
- 時間範囲を確認（開始 < 終了、ファイル長以内）
- より短い時間範囲で試行

## 📝 開発者向け情報

### デバッグ方法
1. **デバッグ情報の確認**: 音声詳細ページ下部の「🔧 デバッグ情報」を展開
2. **ログの確認**: Streamlitのコンソール出力を確認
3. **ファイルパス確認**: デバッグ情報で実際の音声ファイルパスを確認

### カスタマイズポイント
- **`utils/audio_processor.py`**: 音声処理ロジックの変更
- **`config.py`**: パス設定やサポート形式の変更
- **`pages/audio_detail.py`**: UIレイアウトや機能の追加

### 新機能追加の指針
1. **音声処理ロジック**: `AudioProcessor`クラスに追加
2. **UI コンポーネント**: `AudioPlayerComponent`クラスに追加
3. **設定値**: `config.py`に集約
4. **エラーハンドリング**: `@handle_audio_errors`デコレータを活用

---

**Phase 2実装完了日**: 2025年7月19日  
**次の実装**: Phase 3 - スペクトログラム表示機能
